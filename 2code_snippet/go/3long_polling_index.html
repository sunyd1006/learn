<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Long Polling Chat</title>
</head>
<body>
  <h1>ğŸ“¨ Long Polling Example</h1>
  <div id="messages">
        <!-- ç»“æœæ¶ˆæ¯ä¼šå†™åœ¨è¿™é‡Œ -->
  </div>

  <input id="msgInput" type="text" placeholder="Type a message">
  <button onclick="sendMessage()">Send</button>

  <script>
    // ğŸ” å¯åŠ¨ long polling é€»è¾‘
    function longPoll() {
      fetch('/poll') // å‘èµ· GET è¯·æ±‚åˆ° /poll
        .then(response => response.json()) // å°†è¿”å›ç»“æœè½¬æˆ JSON æ ¼å¼
        .then(data => {
          if (data.message) { // å¦‚æœæœåŠ¡å™¨æœ‰æ–°æ¶ˆæ¯
            showMessage("æ”¶åˆ°ï¼š" + data.message);
          }
          longPoll(); // ç»§ç»­ä¸‹ä¸€æ¬¡è½®è¯¢ï¼ˆå…³é”®ï¼ï¼‰
        })
        .catch(err => {
          console.error("è¯·æ±‚å¤±è´¥ï¼š", err);
          showMessage("timeout message from client ");
          setTimeout(longPoll, 3000); // å¤±è´¥åç­‰å¾… 3 ç§’å†è¯•
        });
    }

    // ğŸ“¤ å‘é€æ¶ˆæ¯ç»™æœåŠ¡å™¨
    function sendMessage() {
      const msg = document.getElementById("msgInput").value;
      fetch('/send', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: msg }) // å‘é€ JSON æ•°æ®
      });
      document.getElementById("msgInput").value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
    }

    // ğŸ–¥ï¸ æ˜¾ç¤ºæ¶ˆæ¯åœ¨é¡µé¢ä¸Š
    function showMessage(text) {
      const div = document.createElement("div");
      div.textContent = text;
      document.getElementById("messages").appendChild(div);
    }

    // ğŸš€ é¡µé¢åŠ è½½åï¼Œè‡ªåŠ¨å¯åŠ¨è½®è¯¢
    longPoll();
  </script>
</body>
</html>